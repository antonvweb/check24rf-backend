name: Deploy dev (All modules)

on:
  push:
    branches:
      - dev

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ‚úÖ SSH Connection Test
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo ‚úÖ SSH connected"

      - name: üì§ Sync root files
        run: |
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222" ./pom.xml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222" ./ecosystem.backend.config.js ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: üì§ Sync all modules
        run: |
          MODULES="common mcoService adminPanelService userService archiveService notificationService authService checkService checkRenderService billingService supportService"
          
          for module in $MODULES; do
            echo "üì¶ Syncing $module..."
            rsync -avz --delete \
              -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222" \
              --exclude .git \
              --exclude .idea \
              --exclude target \
              --exclude node_modules \
              ./$module/ \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/$module/
          done

      - name: üî® Build all modules on server
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "üì¶ Installing parent POM..."
            mvn clean install -f pom.xml -DskipTests
          
            echo "üî® Building common module..."
            cd common
            mvn clean install -U -DskipTests
            cd ..
          
            echo "üî® Building all services..."
            for service in mcoService adminPanelService userService archiveService notificationService authService checkService checkRenderService billingService supportService; do
              if [ -d "$service" ]; then
                echo "üì¶ Building $service..."
                cd $service
                mvn clean package -U -DskipTests
                cd ..
              fi
            done
          
            echo "‚úÖ All modules built successfully!"
          EOF

      - name: üîÑ Restart all PM2 services
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "üîÑ Restarting all services..."
            pm2 restart ecosystem.backend.config.js || pm2 start ecosystem.backend.config.js
            pm2 save
          
            echo "üìä PM2 status:"
            pm2 list
          EOF