name: Deploy main (All modules)

on:
  push:
    branches:
      - main

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞
          echo "üîç Checking key format..."
          head -1 ~/.ssh/deploy_key

      - name: ‚úÖ SSH Connection Test
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              -o PubkeyAuthentication=yes \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo ‚úÖ SSH connected"

      - name: üì§ Sync root files
        env:
          SSH_AUTH_SOCK: ""
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
            ./pom.xml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
            ./ecosystem.backend.config.js ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: üì§ Sync all modules
        env:
          SSH_AUTH_SOCK: ""
        run: |
          MODULES="mcoService adminPanelService userService authService"
          
          for module in $MODULES; do
            echo "üì¶ Syncing $module..."
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
              --exclude .git \
              --exclude .idea \
              --exclude target \
              --exclude node_modules \
              ./$module/ \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/$module/
          done

      - name: üî® Build all modules on server
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "üì¶ Installing parent POM..."
            mvn clean install -f pom.xml -DskipTests
          
            echo "üî® Building common module..."
            cd common
            mvn clean install -U -DskipTests
            cd ..
          
            echo "üî® Building all services..."
            for service in mcoService adminPanelService userService authService; do
              if [ -d "$service" ]; then
                echo "üì¶ Building $service..."
                cd $service
                mvn clean package -U -DskipTests
                cd ..
              fi
            done
          
            echo "All modules built successfully!"
          EOF

      - name: üîÑ Restart all PM2 services
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "üîÑ Restarting all services..."
            pm2 restart ecosystem.backend.config.js || pm2 start ecosystem.backend.config.js
            pm2 save
          
            echo "üìä PM2 status:"
            pm2 list
          EOF