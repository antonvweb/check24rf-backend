name: Deploy dev (Parallel build)

on:
  push:
    branches:
      - dev

jobs:
  # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ common Ð¸ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ POM
  build-common:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Sync files
        run: |
          rsync -avz --delete --exclude .git --exclude .idea --exclude target \
            ./pom.xml ./common/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: ðŸ”¨ Build common
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
            mvn install -f pom.xml -DskipTests
            cd common
            mvn clean install -U -DskipTests
          EOF

  # ÐŸÐ¾Ñ‚Ð¾Ð¼ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ð¼ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾
  deploy-services:
    needs: build-common
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [mcoService, adminPanelService, authService, userService, billingService]
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Sync ${{ matrix.service }}
        run: |
          rsync -avz --delete --exclude .idea --exclude target \
            ./${{ matrix.service }}/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/${{ matrix.service }}/

      - name: ðŸ”¨ Build ${{ matrix.service }}
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}/${{ matrix.service }}
            mvn clean package -U -DskipTests
          EOF

      - name: ðŸ”„ Restart ${{ matrix.service }}-dev
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
            pm2 delete ${{ matrix.service }}-dev || true
            pm2 start ecosystem.backend.config.js --only ${{ matrix.service }}-dev
            pm2 save
          EOF