name: Deploy dev (Test)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üß™ Debug ssh-agent
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö SSH-–∫–ª—é—á–µ–π:"
          ssh-add -l || echo "‚ùå –ö–ª—é—á–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"

      - name: üß± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        continue-on-error: false

      - name: üîå Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo ‚úÖ SSH connection established"

      - name: Sync project to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: Build backend on server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
            mvn clean package
          EOF

      - name: Restart backend server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_DEV_PATH }}
            sudo pm2 delete check24rfAPI-ip || true
           sudo pm2 start java --name check24rfAPI-dev -- -jar target/taskPilotApo-1.0-SNAPSHOT.jar --spring.profiles.active=dev
            sudo pm2 save
          EOF