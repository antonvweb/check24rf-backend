name: Deploy dev (All modules)

on:
  push:
    branches:
      - dev

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: âœ… SSH Connection Test
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o IdentityFile=~/.ssh/deploy_key \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo âœ… SSH connected"

      - name: ðŸ“¤ Sync root files
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes" \
            ./pom.xml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes" \
            ./ecosystem.backend.config.js ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: ðŸ“¤ Sync all modules
        run: |
          MODULES="common mcoService adminPanelService userService archiveService notificationService authService checkService checkRenderService billingService supportService"
          
          for module in $MODULES; do
            echo "ðŸ“¦ Syncing $module..."
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes" \
              --exclude .git \
              --exclude .idea \
              --exclude target \
              --exclude node_modules \
              ./$module/ \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/$module/
          done

      - name: ðŸ”¨ Build all modules on server
        run: |
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "ðŸ“¦ Installing parent POM..."
            mvn clean install -f pom.xml -DskipTests
          
            echo "ðŸ”¨ Building common module..."
            cd common
            mvn clean install -U -DskipTests
            cd ..
          
            echo "ðŸ”¨ Building all services..."
            for service in mcoService adminPanelService userService archiveService notificationService authService checkService checkRenderService billingService supportService; do
              if [ -d "$service" ]; then
                echo "ðŸ“¦ Building $service..."
                cd $service
                mvn clean package -U -DskipTests
                cd ..
              fi
            done
          
            echo "âœ… All modules built successfully!"
          EOF

      - name: ðŸ”„ Restart all PM2 services
        run: |
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            echo "ðŸ”„ Restarting all services..."
            pm2 restart ecosystem.backend.config.js || pm2 start ecosystem.backend.config.js
            pm2 save
          
            echo "ðŸ“Š PM2 status:"
            pm2 list
          EOF