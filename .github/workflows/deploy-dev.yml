name: Deploy main (All modules)

on:
  push:
    branches:
      - main

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞
          echo "üîç Checking key format..."
          head -1 ~/.ssh/deploy_key

      - name: ‚úÖ SSH Connection Test
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              -o PubkeyAuthentication=yes \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "echo ‚úÖ SSH connected"

      - name: üì§ Sync root files
        env:
          SSH_AUTH_SOCK: ""
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
            ./pom.xml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
            ./ecosystem.backend.config.js ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: üì§ Sync all modules
        env:
          SSH_AUTH_SOCK: ""
        run: |
          MODULES="mcoService common adminPanelService userService authService"
          
          for module in $MODULES; do
            echo "üì¶ Syncing $module..."
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o PreferredAuthentications=publickey" \
              --exclude .git \
              --exclude .idea \
              --exclude target \
              --exclude node_modules \
              ./$module/ \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/$module/
          done

      - name: üî® Build all modules on server (one-shot build)
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "üßπ Cleaning previous builds..."
            mvn clean -f pom.xml

            echo "üì¶ Building entire project once (parent + all modules)..."
            mvn clean install -U -DskipTests -T 1C  # -T 1C = –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ, —É—Å–∫–æ—Ä—è–µ—Ç –Ω–∞ 30‚Äì60%

            echo "All modules built successfully in one pass!"
          EOF

      - name: üîÑ Restart all PM2 services
        env:
          SSH_AUTH_SOCK: ""
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
          
            echo "üîÑ Restarting all services..."
            pm2 restart ecosystem.backend.config.js || pm2 start ecosystem.backend.config.js
            pm2 save
          
            echo "üìä PM2 status:"
            pm2 list
          EOF